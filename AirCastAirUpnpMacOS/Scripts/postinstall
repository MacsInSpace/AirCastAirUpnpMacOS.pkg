#!/bin/sh
## postinstall
##
## https://github.com/philippe44/AirConnect
##
## Downloads latest release zip, extracts, and installs correct executables for macOS

pathToScript=$0
pathToPackage=$1
targetLocation=$2
targetVolume=$3

# Configuration
FALLBACK_VERSION="1.9.3"  # Used if GitHub API is unavailable
GITHUB_REPO="philippe44/AirConnect"
GITHUB_API="https://api.github.com/repos/${GITHUB_REPO}/releases/latest"
TMP_DIR="/private/var/tmp"
BIN_DIR="/usr/local/bin"

function with_backoff {
  local max_attempts=${ATTEMPTS-5}
  local timeout=${TIMEOUT-1}
  local attempt=1
  local exitCode=0

  while [ $attempt -lt $max_attempts ]
  do
    if "$@"
    then
      return 0
    else
      exitCode=$?
    fi

    echo "Failure! Retrying in $timeout.." 1>&2
    sleep $timeout
    attempt=$(( attempt + 1 ))
    timeout=$(( timeout * 2 ))
  done

  if [ $exitCode != 0 ]
  then
    echo "You've failed me for the last time! ($@)" 1>&2
  fi

  return $exitCode
}

#
# Get latest version from GitHub releases
#
function get_latest_version() {
    echo "Checking for latest AirConnect version..."
    
    # Try to get latest release tag from GitHub API
    LATEST_VERSION=$(curl -sL "$GITHUB_API" | grep '"tag_name":' | sed -E 's/.*"tag_name": "([^"]+)".*/\1/' | head -n 1)
    
    # Remove 'v' prefix if present (e.g., "v1.9.3" -> "1.9.3")
    LATEST_VERSION=${LATEST_VERSION#v}
    
    if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" = "null" ]; then
        echo "Warning: Could not determine latest version from GitHub API." 1>&2
        echo "Using fallback version: ${FALLBACK_VERSION}" 1>&2
        LATEST_VERSION="$FALLBACK_VERSION"
    else
        echo "Found latest version: ${LATEST_VERSION}"
    fi
    
    echo "$LATEST_VERSION"
}

#
# Get current logged in user
#
loggedInUser=$(/bin/ls -l /dev/console | /usr/bin/awk '{ print $3 }')

#
# Stop services if they exist (handle both old and new naming)
#
echo "Stopping services if loaded...."
sudo -u "$loggedInUser" launchctl unload -w /Library/LaunchAgents/com.aircast.plist 2>/dev/null
sudo -u "$loggedInUser" launchctl unload -w /Library/LaunchAgents/com.airupnp.plist 2>/dev/null
# Also unload old naming for upgrades
sudo -u "$loggedInUser" launchctl unload -w /Library/LaunchAgents/com.aircast-osx-multi.plist 2>/dev/null
sudo -u "$loggedInUser" launchctl unload -w /Library/LaunchAgents/com.airupnp-osx-multi.plist 2>/dev/null
echo "Services stopped (if they were running)."

#
# Detect macOS architecture
#
ARCH=$(uname -m)
if [ "$ARCH" = "arm64" ]; then
    AIRCAST_EXE="aircast-macos-arm64"
    AIRUPNP_EXE="airupnp-macos-arm64"
    echo "Detected Apple Silicon (ARM64) architecture."
elif [ "$ARCH" = "x86_64" ]; then
    AIRCAST_EXE="aircast-macos-x86_64"
    AIRUPNP_EXE="airupnp-macos-x86_64"
    echo "Detected Intel (x86_64) architecture."
else
    # Fallback to universal macOS binary
    AIRCAST_EXE="aircast-macos"
    AIRUPNP_EXE="airupnp-macos"
    echo "Detected unknown architecture ($ARCH), using universal macOS binary."
fi

#
# Create /usr/local/bin if it doesn't exist
#
echo "Checking for ${BIN_DIR} folder..."
if [ ! -d "$BIN_DIR" ]; then
    echo "Creating ${BIN_DIR} folder..."
    mkdir -p -m 775 "$BIN_DIR"
    export PATH=$PATH:"$BIN_DIR"
    echo "Created ${BIN_DIR} and added it to PATH."
fi

#
# Get latest version and set up paths
#
VERSION=$(get_latest_version)
ZIP_FILE="${TMP_DIR}/AirConnect-${VERSION}.zip"
EXTRACT_DIR="${TMP_DIR}/AirConnect-${VERSION}"

#
# Download latest release zip
#
echo "Downloading AirConnect ${VERSION} from GitHub releases..."
ZIP_URL="https://github.com/${GITHUB_REPO}/archive/refs/tags/${VERSION}.zip"

cd "$TMP_DIR" || exit 1

# Clean up any existing download/extraction
rm -f "$ZIP_FILE"
rm -rf "$EXTRACT_DIR"

if ! with_backoff curl -L -o "$ZIP_FILE" "$ZIP_URL"; then
    echo "ERROR: Failed to download AirConnect release zip." 1>&2
    exit 1
fi

echo "Download complete."

#
# Extract the zip file
#
echo "Extracting AirConnect ${VERSION}..."
if ! unzip -q "$ZIP_FILE" -d "$TMP_DIR"; then
    echo "ERROR: Failed to extract zip file." 1>&2
    rm -f "$ZIP_FILE"
    exit 1
fi

echo "Extraction complete."

#
# Verify executables exist and copy them
#
AIRCAST_SRC="${EXTRACT_DIR}/${AIRCAST_EXE}"
AIRUPNP_SRC="${EXTRACT_DIR}/${AIRUPNP_EXE}"

if [ ! -f "$AIRCAST_SRC" ]; then
    echo "ERROR: Executable not found: ${AIRCAST_SRC}" 1>&2
    rm -f "$ZIP_FILE"
    rm -rf "$EXTRACT_DIR"
    exit 1
fi

if [ ! -f "$AIRUPNP_SRC" ]; then
    echo "ERROR: Executable not found: ${AIRUPNP_SRC}" 1>&2
    rm -f "$ZIP_FILE"
    rm -rf "$EXTRACT_DIR"
    exit 1
fi

echo "Copying executables to ${BIN_DIR}..."
cp "$AIRCAST_SRC" "${BIN_DIR}/aircast"
cp "$AIRUPNP_SRC" "${BIN_DIR}/airupnp"

if [ $? -ne 0 ]; then
    echo "ERROR: Failed to copy executables." 1>&2
    rm -f "$ZIP_FILE"
    rm -rf "$EXTRACT_DIR"
    exit 1
fi

echo "Executables copied successfully."

#
# Set executable permissions
#
echo "Setting executable permissions..."
/bin/chmod +x "${BIN_DIR}/aircast"
/bin/chmod +x "${BIN_DIR}/airupnp"
echo "Permissions set."

#
# Clean up downloaded files
#
echo "Cleaning up temporary files..."
rm -f "$ZIP_FILE"
rm -rf "$EXTRACT_DIR"
echo "Cleanup complete."

#
# Create log files and set permissions
#
echo "Setting up log files..."
if [ ! -f "/var/log/aircast.log" ]; then
    touch /var/log/aircast.log
    chmod 755 /var/log/aircast.log
fi

if [ ! -f "/var/log/airupnp.log" ]; then
    touch /var/log/airupnp.log
    chmod 755 /var/log/airupnp.log
fi

echo "START OF NEW INSTALL LOG - $(date)" >> /var/log/aircast.log
echo "START OF NEW INSTALL LOG - $(date)" >> /var/log/airupnp.log

#
# Start services
#
echo "Starting services..."
sudo -u "$loggedInUser" launchctl load -w /Library/LaunchAgents/com.aircast.plist
sudo -u "$loggedInUser" launchctl load -w /Library/LaunchAgents/com.airupnp.plist
echo "Services started."

echo "Installation complete!"

exit 0
